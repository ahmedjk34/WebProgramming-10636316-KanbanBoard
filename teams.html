<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teams - Kanban Task Board</title>
    <meta
      name="description"
      content="Team collaboration and project management"
    />
    <meta name="author" content="Web Programming 10636316 Student" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico" />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/teams.css" />

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="teams-page">
    <!-- Loading Screen -->
    <div id="teams-loading" class="app-loading-screen">
      <div class="loading-brand">
        <div class="loading-logo">👥</div>
        <h1 class="loading-app-title">Team Collaboration</h1>
        <p class="loading-subtitle">Loading team workspaces...</p>
      </div>

      <div class="loading-spinner"></div>

      <div class="loading-progress">
        <div class="loading-progress-bar">
          <div class="loading-progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <div class="loading-status">Initializing team collaboration...</div>

      <div class="loading-steps">
        <div class="loading-step" data-step="auth">
          <div class="loading-step-icon">1</div>
          <div class="loading-step-text">Checking authentication</div>
        </div>
        <div class="loading-step" data-step="teams">
          <div class="loading-step-icon">2</div>
          <div class="loading-step-text">Loading teams</div>
        </div>
        <div class="loading-step" data-step="workspaces">
          <div class="loading-step-icon">3</div>
          <div class="loading-step-text">Loading workspaces</div>
        </div>
        <div class="loading-step" data-step="ready">
          <div class="loading-step-icon">4</div>
          <div class="loading-step-text">Ready to collaborate</div>
        </div>
      </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Teams Navigation Header -->
    <header class="teams-header">
      <div class="header-container">
        <div class="header-left">
          <div class="navigation-tabs">
            <a href="index.html" class="nav-tab">
              <span class="tab-icon">👤</span>
              <span class="tab-text">Personal</span>
            </a>
            <a href="teams.html" class="nav-tab active">
              <span class="tab-icon">👥</span>
              <span class="tab-text">Teams</span>
            </a>
          </div>

          <h1 class="teams-title">
            <span class="title-icon">🚀</span>
            Team Collaboration Hub
          </h1>
        </div>

        <div class="header-controls">
          <button
            id="create-team-btn"
            class="btn btn-primary"
            onclick="openCreateTeamDialog()"
          >
            <span class="btn-icon">➕</span>
            Create Team
          </button>

          <button
            id="theme-toggle"
            class="theme-toggle"
            title="Toggle Dark/Light Mode"
          >
            <span id="theme-icon">🌙</span>
          </button>

          <div class="user-menu">
            <button
              id="user-menu-btn"
              class="user-menu-btn"
              onclick="toggleUserMenu()"
            >
              <span class="user-avatar">👤</span>
              <span class="user-name" id="user-name">Guest User</span>
              <span class="menu-arrow">▼</span>
            </button>
            <div id="user-menu-dropdown" class="user-menu-dropdown">
              <a href="index.html" class="menu-item">
                <span class="menu-icon">👤</span>
                Personal Dashboard
              </a>
              <a href="dashboard.html" class="menu-item">
                <span class="menu-icon">📊</span>
                Analytics Dashboard
              </a>
              <div class="menu-divider"></div>
              <button class="menu-item" onclick="logout()">
                <span class="menu-icon">🚪</span>
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="teams-main">
      <div class="teams-container">
        <!-- Teams Overview Section -->
        <section class="teams-overview">
          <div class="overview-header">
            <h2>My Teams</h2>
            <div class="overview-stats">
              <div class="stat-item">
                <span class="stat-number" id="total-teams">0</span>
                <span class="stat-label">Teams</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="total-members">0</span>
                <span class="stat-label">Members</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="active-projects">0</span>
                <span class="stat-label">Projects</span>
              </div>
            </div>
          </div>

          <!-- Teams Controls -->
          <div class="teams-controls">
            <div class="teams-search">
              <input
                type="text"
                id="teams-search"
                placeholder="Search teams..."
                autocomplete="off"
              />
            </div>
            <div class="teams-filters">
              <button
                class="filter-btn active"
                data-filter="status"
                data-value="all"
              >
                All Teams
              </button>
              <button
                class="filter-btn"
                data-filter="status"
                data-value="active"
              >
                Active
              </button>
              <button
                class="filter-btn"
                data-filter="status"
                data-value="archived"
              >
                Archived
              </button>
            </div>
          </div>

          <!-- Loading State -->
          <div id="teams-loader" class="teams-loader">
            <div class="loading-spinner"></div>
            <p>Loading teams...</p>
          </div>

          <!-- Current Team Display -->
          <div id="current-team" style="display: none">
            <!-- Current team info will be displayed here -->
          </div>

          <div id="teams-grid" class="teams-grid">
            <!-- Teams will be loaded dynamically -->
          </div>
        </section>

        <!-- Team Activity Feed -->
        <aside class="team-activity-sidebar">
          <div class="activity-header">
            <h3>📊 Team Activity</h3>
            <button
              class="refresh-activity-btn"
              onclick="refreshTeamActivity()"
              title="Refresh Activity"
            >
              🔄
            </button>
          </div>
          <div class="activity-feed">
            <div id="team-activity-feed" class="activity-feed">
              <!-- Activity items will be loaded dynamically -->
              <div class="activity-placeholder">
                <div class="activity-icon">📊</div>
                <div class="activity-content">
                  <div class="activity-text">No team selected</div>
                  <div class="activity-time">Select a team to see activity</div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Team Management Dialogs -->

    <!-- Create Team Dialog -->
    <dialog id="create-team-dialog" class="create-team-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3>👥 Create New Team</h3>
          <button
            type="button"
            class="dialog-close"
            onclick="closeCreateTeamDialog()"
          >
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
          </button>
        </div>
        <div class="dialog-body">
          <form id="create-team-form">
            <div class="form-group">
              <label for="team-name">Team Name *</label>
              <input
                type="text"
                id="team-name"
                name="name"
                required
                placeholder="Enter team name"
                maxlength="100"
              />
            </div>
            <div class="form-group">
              <label for="team-description">Description</label>
              <textarea
                id="team-description"
                name="description"
                placeholder="Enter team description"
                rows="3"
                maxlength="500"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="team-visibility">Visibility</label>
              <select id="team-visibility" name="visibility">
                <option value="private">Private</option>
                <option value="public">Public</option>
              </select>
            </div>
            <div class="form-group">
              <label for="team-color">Team Color</label>
              <input
                type="color"
                id="team-color"
                name="color"
                value="#667eea"
              />
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeCreateTeamDialog()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <span class="btn-icon">🚀</span>
                Create Team
              </button>
            </div>
          </form>
        </div>
      </div>
    </dialog>

    <!-- Edit Team Dialog -->
    <dialog id="edit-team-dialog" class="edit-team-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3>✏️ Edit Team</h3>
          <button
            type="button"
            class="dialog-close"
            onclick="closeEditTeamDialog()"
          >
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
          </button>
        </div>
        <div class="dialog-body">
          <form id="edit-team-form">
            <input type="hidden" id="edit-team-id" name="id" />
            <div class="form-group">
              <label for="edit-team-name">Team Name *</label>
              <input
                type="text"
                id="edit-team-name"
                name="name"
                required
                placeholder="Enter team name"
                maxlength="100"
              />
            </div>
            <div class="form-group">
              <label for="edit-team-description">Description</label>
              <textarea
                id="edit-team-description"
                name="description"
                placeholder="Enter team description"
                rows="3"
                maxlength="500"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="edit-team-visibility">Visibility</label>
              <select id="edit-team-visibility" name="visibility">
                <option value="private">Private</option>
                <option value="public">Public</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-team-color">Team Color</label>
              <input
                type="color"
                id="edit-team-color"
                name="color"
                value="#667eea"
              />
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeEditTeamDialog()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <span class="btn-icon">💾</span>
                Update Team
              </button>
            </div>
          </form>
        </div>
      </div>
    </dialog>

    <!-- Invite Member Dialog -->
    <dialog id="invite-member-dialog" class="invite-member-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3>📧 Invite Team Member</h3>
          <button
            type="button"
            class="dialog-close"
            onclick="closeInviteMemberDialog()"
          >
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
          </button>
        </div>
        <div class="dialog-body">
          <form id="invite-member-form">
            <div class="form-group">
              <label for="invite-email">Email Address *</label>
              <input
                type="email"
                id="invite-email"
                name="email"
                required
                placeholder="Enter email address"
              />
            </div>
            <div class="form-group">
              <label for="invite-role">Role</label>
              <select id="invite-role" name="role">
                <option value="member">Member</option>
                <option value="admin">Admin</option>
                <option value="viewer">Viewer</option>
              </select>
            </div>
            <div class="form-group">
              <label for="invite-message">Personal Message (Optional)</label>
              <textarea
                id="invite-message"
                name="message"
                placeholder="Add a personal message to your invitation..."
                rows="3"
              ></textarea>
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeInviteMemberDialog()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <span class="btn-icon">📧</span>
                Send Invitation
              </button>
            </div>
          </form>
        </div>
      </div>
    </dialog>

    <!-- Team Analytics Dialog -->
    <dialog id="team-analytics-dialog" class="team-analytics-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3>📊 Team Analytics</h3>
          <div class="dialog-actions">
            <button
              class="btn btn-secondary btn-small"
              onclick="exportTeamAnalytics('json')"
            >
              📄 Export JSON
            </button>
            <button
              class="btn btn-secondary btn-small"
              onclick="exportTeamAnalytics('csv')"
            >
              📊 Export CSV
            </button>
            <button class="dialog-close" onclick="closeTeamAnalyticsDialog()">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        </div>
        <div class="dialog-body">
          <div class="analytics-grid">
            <div class="analytics-card">
              <h4>Team Performance</h4>
              <canvas id="team-performance-chart"></canvas>
            </div>
            <div class="analytics-card">
              <h4>Member Activity</h4>
              <canvas id="member-activity-chart"></canvas>
            </div>
            <div class="analytics-card">
              <h4>Project Progress</h4>
              <canvas id="project-progress-chart"></canvas>
            </div>
            <div class="analytics-card">
              <h4>Task Completion</h4>
              <canvas id="task-completion-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </dialog>

    <!-- Scripts -->
    <script src="utils/js-utils.js"></script>
    <script src="js/auth-check.js"></script>
    <script src="js/analytics-app.js"></script>
    <script src="js/app.js"></script>

    <!-- Authentication Enforcement -->
    <script>
      // Ensure user is authenticated before loading teams page
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          console.log("🔐 Checking authentication...");
          // Check authentication
          const response = await fetch("php/api/auth/check_auth.php");
          const result = await response.json();

          if (!result.success || !result.authenticated) {
            // Redirect to login if not authenticated
            console.log("❌ Not authenticated, redirecting to login");
            window.location.href = "login.html";
            return;
          }

          // Continue with teams page initialization
          console.log("✅ Authentication verified for teams page");
          console.log("👤 User data:", result.data);

          // Update user name in the header
          if (result.data && result.data.user) {
            const userNameElement = document.getElementById("user-name");
            if (userNameElement) {
              userNameElement.textContent =
                result.data.user.first_name + " " + result.data.user.last_name;
            }
          }
        } catch (error) {
          console.error("❌ Authentication check failed:", error);
          window.location.href = "login.html";
        }
      });
    </script>
    <script src="modules/APIManager.js"></script>
    <script src="modules/TaskManager.js"></script>
    <script src="modules/ProjectManager.js"></script>
    <script src="modules/WorkspaceManager.js"></script>
    <script src="modules/UIManager.js"></script>
    <script src="modules/ViewManager.js"></script>
    <script src="modules/DragDropManager.js"></script>
    <script src="modules/ChartManager.js"></script>
    <script src="modules/AnalyticsDataManager.js"></script>
    <script src="modules/AIChatManager.js"></script>
    <script src="modules/TeamManager.js"></script>
    <script src="modules/TeamCollaborationManager.js"></script>
    <script src="modules/TeamAnalyticsManager.js"></script>
    <script src="js/teams-app.js"></script>

    <!-- Theme and User Menu Functions -->
    <script>
      // User menu toggle function
      window.toggleUserMenu = () => {
        const dropdown = document.getElementById("user-menu-dropdown");
        const button = document.getElementById("user-menu-btn");

        if (dropdown.classList.contains("show")) {
          dropdown.classList.remove("show");
          button.classList.remove("active");
        } else {
          dropdown.classList.add("show");
          button.classList.add("active");
        }
      };

      // Theme toggle function
      window.toggleTheme = () => {
        const html = document.documentElement;
        const themeIcon = document.getElementById("theme-icon");
        const currentTheme = html.getAttribute("data-theme") || "light";

        console.log("🎨 Theme toggle clicked");
        console.log("Current theme:", currentTheme);

        const newTheme = currentTheme === "light" ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);

        // Update theme icon
        themeIcon.textContent = newTheme === "light" ? "🌙" : "☀️";

        console.log("✅ Switched to", newTheme, "mode");
      };

      // Logout function
      window.logout = async () => {
        try {
          const response = await fetch("php/api/auth/logout.php", {
            method: "POST",
          });

          if (response.ok) {
            window.location.href = "login.html";
          } else {
            console.error("Logout failed");
          }
        } catch (error) {
          console.error("Logout error:", error);
        }
      };

      // Close user menu when clicking outside
      document.addEventListener("click", (e) => {
        const userMenu = document.querySelector(".user-menu");
        const dropdown = document.getElementById("user-menu-dropdown");

        if (
          !userMenu.contains(e.target) &&
          dropdown.classList.contains("show")
        ) {
          dropdown.classList.remove("show");
          document.getElementById("user-menu-btn").classList.remove("active");
        }
      });

      // Update user info function
      function updateUserInfo() {
        fetch("php/api/auth/check_auth.php")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.authenticated && data.data?.user) {
              const user = data.data.user;
              const userNameElement = document.getElementById("user-name");
              const userAvatarElement = document.querySelector(".user-avatar");

              if (userNameElement) {
                userNameElement.textContent =
                  user.first_name && user.last_name
                    ? `${user.first_name} ${user.last_name}`
                    : user.username || "User";
              }

              if (userAvatarElement) {
                userAvatarElement.textContent = user.first_name
                  ? user.first_name.charAt(0).toUpperCase()
                  : "👤";
              }
            }
          })
          .catch((error) => {
            console.error("Error fetching user info:", error);
          });
      }

      // Initialize theme on page load
      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        if (typeof window.initializeTheme === "function") {
          window.initializeTheme(savedTheme);
        } else {
          // Fallback theme initialization
          const themeIcon = document.getElementById("theme-icon");
          const html = document.documentElement;
          html.setAttribute("data-theme", savedTheme);
          if (themeIcon) {
            themeIcon.textContent = savedTheme === "light" ? "🌙" : "☀️";
          }
        }

        console.log("🎨 Theme initialized:", savedTheme);

        // Add click handler to theme toggle
        const themeToggle = document.getElementById("theme-toggle");
        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const currentTheme =
              document.documentElement.getAttribute("data-theme") || "light";
            window.toggleTheme(currentTheme);
          });
        }

        // Update user info
        updateUserInfo();

        // Teams page loading screen
        const loadingScreen = document.getElementById("teams-loading");
        const progressFill = loadingScreen?.querySelector(
          ".loading-progress-fill"
        );
        const statusElement = loadingScreen?.querySelector(".loading-status");

        let progress = 0;
        const steps = ["auth", "teams", "workspaces", "ready"];
        let currentStep = 0;

        function updateProgress(percentage, status) {
          progress = percentage;
          if (progressFill) progressFill.style.width = percentage + "%";
          if (statusElement) statusElement.textContent = status;
        }

        function completeStep(stepName) {
          const stepElement = loadingScreen?.querySelector(
            `[data-step="${stepName}"]`
          );
          if (stepElement) {
            stepElement.classList.remove("active");
            stepElement.classList.add("completed");
            stepElement.querySelector(".loading-step-icon").textContent = "✓";
          }
        }

        function activateStep(stepName) {
          const stepElement = loadingScreen?.querySelector(
            `[data-step="${stepName}"]`
          );
          if (stepElement) {
            stepElement.classList.add("active");
          }
        }

        // Start loading process
        updateProgress(0, "Initializing team collaboration...");
        activateStep("auth");

        // Simulate loading steps
        setTimeout(() => {
          completeStep("auth");
          activateStep("teams");
          updateProgress(25, "Loading teams...");
        }, 1000);

        setTimeout(() => {
          completeStep("teams");
          activateStep("workspaces");
          updateProgress(50, "Loading workspaces...");
        }, 2000);

        setTimeout(() => {
          completeStep("workspaces");
          activateStep("ready");
          updateProgress(75, "Preparing collaboration tools...");
        }, 3000);

        setTimeout(() => {
          completeStep("ready");
          updateProgress(100, "Ready to collaborate!");

          setTimeout(() => {
            if (loadingScreen) {
              loadingScreen.classList.add("fade-out");
              setTimeout(() => {
                if (loadingScreen.parentNode) {
                  loadingScreen.parentNode.removeChild(loadingScreen);
                }
              }, 500);
            }
          }, 1000);
        }, 4000);
      });
    </script>
  </body>
</html>
